---
import Layout from "../layouts/Layout.astro";

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
---

<Layout title="Panel de Administrador">
  <div style="max-width: 1200px; margin: 2rem auto;">
    <h2>Panel de Administrador</h2>

    <div style="margin-bottom: 1rem;">
      <button onclick="logout()" style="background-color: var(--color-danger);">Cerrar Sesión</button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem;">
      <div style="background: white; padding: 1.5rem; border-radius: 0.5rem;">
        <h3>Eventos</h3>
        <div id="eventosCount" style="font-size: 2rem; color: var(--color-primary);">-</div>
        <button onclick="loadSection('eventos')">Gestionar Eventos</button>
      </div>

      <div style="background: white; padding: 1.5rem; border-radius: 0.5rem;">
        <h3>Usuarios</h3>
        <div id="usuariosCount" style="font-size: 2rem; color: var(--color-primary);">-</div>
        <button onclick="loadSection('usuarios')">Gestionar Usuarios</button>
      </div>
    </div>

    <div id="sectionContent" style="margin-top: 3rem;"></div>
    <div id="message"></div>
  </div>

  <script define:vars={{ API_URL }}>
    const accessToken = localStorage.getItem('accessToken');
    const messageEl = document.getElementById('message');

    if (!accessToken) {
      window.location.href = '/login';
    }

    async function loadEventos() {
      try {
        const response = await fetch(`${API_URL}/api/admin/eventos`, {
          headers: {
            'Authorization': 'Bearer ' + accessToken,
          },
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error?.message || 'Error al cargar eventos');
        }

        document.getElementById('eventosCount').textContent = data.total;

        const content = document.getElementById('sectionContent');
        content.innerHTML = '<h3>Eventos</h3>';

        const table = document.createElement('table');
        table.style.cssText = 'width: 100%; border-collapse: collapse; margin-top: 1rem;';
        table.innerHTML = `
          <thead>
            <tr style="background-color: var(--color-gray-light);">
              <th style="padding: 0.75rem; text-align: left;">Nombre</th>
              <th style="padding: 0.75rem; text-align: left;">Tipo</th>
              <th style="padding: 0.75rem; text-align: left;">Precio</th>
              <th style="padding: 0.75rem; text-align: left;">Activo</th>
            </tr>
          </thead>
          <tbody>
            ${data.data.map(e => `
              <tr style="border-bottom: 1px solid #d1d5db;">
                <td style="padding: 0.75rem;">${e.nombre}</td>
                <td style="padding: 0.75rem;">${e.tipo}</td>
                <td style="padding: 0.75rem;">€${e.precio_base || '-'}</td>
                <td style="padding: 0.75rem;">${e.activo ? 'Sí' : 'No'}</td>
              </tr>
            `).join('')}
          </tbody>
        `;
        content.appendChild(table);
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    }

    async function loadUsuarios() {
      try {
        const response = await fetch(`${API_URL}/api/admin/usuarios`, {
          headers: {
            'Authorization': 'Bearer ' + accessToken,
          },
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error?.message || 'Error al cargar usuarios');
        }

        document.getElementById('usuariosCount').textContent = data.total;

        const content = document.getElementById('sectionContent');
        content.innerHTML = '<h3>Usuarios</h3>';

        const table = document.createElement('table');
        table.style.cssText = 'width: 100%; border-collapse: collapse; margin-top: 1rem;';
        table.innerHTML = `
          <thead>
            <tr style="background-color: var(--color-gray-light);">
              <th style="padding: 0.75rem; text-align: left;">Email</th>
              <th style="padding: 0.75rem; text-align: left;">Nombre</th>
              <th style="padding: 0.75rem; text-align: left;">Rol</th>
              <th style="padding: 0.75rem; text-align: left;">Activo</th>
            </tr>
          </thead>
          <tbody>
            ${data.data.map(u => `
              <tr style="border-bottom: 1px solid #d1d5db;">
                <td style="padding: 0.75rem;">${u.email}</td>
                <td style="padding: 0.75rem;">${u.nombre_mostrado}</td>
                <td style="padding: 0.75rem;">${u.rol}</td>
                <td style="padding: 0.75rem;">${u.activo ? 'Sí' : 'No'}</td>
              </tr>
            `).join('')}
          </tbody>
        `;
        content.appendChild(table);
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    }

    function loadSection(section) {
      messageEl.innerHTML = '';
      if (section === 'eventos') {
        loadEventos();
      } else if (section === 'usuarios') {
        loadUsuarios();
      }
    }

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/';
    }

    // Cargar datos iniciales
    loadEventos();
    loadUsuarios();
  </script>
</Layout>
