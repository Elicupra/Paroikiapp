---
import Layout from "../layouts/Layout.astro";

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
---

<Layout title="Panel de Monitor">
  <div style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0;">Panel de Monitor</h2>
      <button onclick="window.logout()" style="background-color: var(--color-danger); padding: 0.5rem 1rem;">Cerrar Sesión</button>
    </div>

    <div id="simBanner" style="display: none; background: #fff7ed; border: 1px solid #fed7aa; padding: 1rem 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
          <strong>Simulando monitor:</strong> <span id="simMonitorName">-</span>
        </div>
        <button id="btnSalirSimulacionMonitor" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Salir de simulacion</button>
      </div>
    </div>

    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem 1.25rem; margin-bottom: 2rem;">
      <h3 style="margin: 0 0 1rem 0;">Mi perfil</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
        <form id="monitorProfileForm" style="border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.75rem;">
          <h4 style="margin:0 0 0.75rem 0;">Datos de perfil</h4>
          <label for="profile_nombre" style="display:block; margin-bottom:0.35rem;">Nombre mostrado</label>
          <input id="profile_nombre" type="text" required style="width:100%; margin-bottom:0.75rem;" />
          <button type="submit" style="width:100%;">Guardar perfil</button>
        </form>

        <form id="monitorEmailForm" style="border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.75rem;">
          <h4 style="margin:0 0 0.75rem 0;">Cambiar correo</h4>
          <label for="profile_email" style="display:block; margin-bottom:0.35rem;">Nuevo email</label>
          <input id="profile_email" type="email" required style="width:100%; margin-bottom:0.5rem;" />
          <label for="profile_email_password" style="display:block; margin-bottom:0.35rem;">Contraseña actual</label>
          <input id="profile_email_password" type="password" required style="width:100%; margin-bottom:0.75rem;" />
          <button type="submit" style="width:100%;">Actualizar correo</button>
        </form>

        <form id="monitorPasswordForm" style="border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.75rem;">
          <h4 style="margin:0 0 0.75rem 0;">Cambiar contraseña</h4>
          <label for="profile_current_password" style="display:block; margin-bottom:0.35rem;">Contraseña actual</label>
          <input id="profile_current_password" type="password" required style="width:100%; margin-bottom:0.5rem;" />
          <label for="profile_new_password" style="display:block; margin-bottom:0.35rem;">Nueva contraseña</label>
          <input id="profile_new_password" type="password" minlength="8" required style="width:100%; margin-bottom:0.75rem;" />
          <button type="submit" style="width:100%;">Actualizar contraseña</button>
        </form>
      </div>
    </div>

    <!-- Selector de Eventos -->
    <div id="eventSelectorContainer" style="display: none;">
      <h3 style="margin-bottom: 1.5rem;">Selecciona un Evento</h3>
      <div id="eventCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
        <!-- Tarjetas de eventos se cargan aquí -->
      </div>
    </div>

    <!-- Contenido del evento seleccionado -->
    <div id="eventContent" style="display: none;">
      <div id="eventHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3 id="selectedEventName" style="margin: 0 0 0.5rem 0; font-size: 1.75rem;">-</h3>
            <p id="selectedEventType" style="margin: 0; opacity: 0.9;">-</p>
          </div>
          <button id="changeEventBtn" onclick="window.showEventSelector()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">
            Cambiar Evento
          </button>
        </div>
      </div>

      <div id="resumenEvento" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;"></div>

      <h3 style="margin-top: 2rem;">Enlaces de Registro</h3>
      <div id="registrationLinks" style="margin: 1rem 0;"></div>

      <h3 style="margin-top: 2rem;">Jóvenes Registrados</h3>
      <div id="jovenesList" style="margin: 1rem 0;"></div>

      <div id="jovenPerfilModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1000; overflow-y: auto;">
        <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 2rem;">
          <div style="background: white; border-radius: 0.75rem; max-width: 900px; width: 100%; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
            <div style="padding: 1rem 1.25rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
              <h3 style="margin: 0;">Perfil del joven</h3>
              <button id="closeJovenPerfilModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div id="jovenPerfilBody" style="padding: 1.25rem;"></div>
          </div>
        </div>
      </div>

      <h3 style="margin-top: 2rem;">Documentos del joven seleccionado</h3>
      <div id="documentosJoven" style="margin: 1rem 0;"></div>

      <h3 style="margin-top: 2rem;">Registrar Pago</h3>
      <form id="pagoForm" style="background: white; padding: 1.5rem; border-radius: 0.5rem; max-width: 500px;">
        <div style="margin-bottom: 1rem;">
          <label for="joven_id" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seleccionar Joven *</label>
          <select 
            id="joven_id" 
            name="joven_id" 
            required 
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; cursor: pointer;">
            <option value="">-- Cargando jóvenes... --</option>
          </select>
        </div>

        <div style="margin-bottom: 1rem;">
          <label for="plazo_numero" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Plazo # *</label>
          <input 
            type="number" 
            id="plazo_numero" 
            name="plazo_numero" 
            min="1" 
            required 
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />
        </div>

        <div style="margin-bottom: 1rem;">
          <label for="cantidad" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Cantidad (€) *</label>
          <input 
            type="number" 
            id="cantidad" 
            name="cantidad" 
            step="0.01" 
            min="0.01"
            required 
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />
        </div>

        <div style="margin-bottom: 1rem;">
          <label for="descuento" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Descuento aplicado (€)</label>
          <input
            type="number"
            id="descuento"
            name="descuento"
            step="0.01"
            min="0"
            value="0"
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: flex; gap: 0.5rem; align-items: center; font-weight: 600; cursor: pointer;">
            <input type="checkbox" id="es_especial" name="es_especial" />
            Trato especial
          </label>
        </div>

        <div style="margin-bottom: 1rem;">
          <label for="nota_especial" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nota de trato especial</label>
          <textarea id="nota_especial" name="nota_especial" rows="2" style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"></textarea>
        </div>

        <button type="submit" style="width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600;">Registrar Pago</button>
      </form>

      <div id="message"></div>
    </div> <!-- Cierra eventContent -->
  </div> <!-- Cierra container principal -->

  <script define:vars={{ API_URL }}>
    // @ts-nocheck
    // Capturar todos los errores
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('[ERROR GLOBAL]', msg);
      console.error('[URL]', url);
      console.error('[Line]', lineNo, 'Column:', columnNo);
      console.error('[Error object]', error);
      return false;
    };

    console.log('[INIT] Monitor script iniciado');
    
    console.log('[CONFIG] API_URL:', API_URL);
    
    const accessToken = localStorage.getItem('accessToken');
    const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
    console.log('[AUTH] AccessToken existe:', !!accessToken);
    
    const messageEl = document.getElementById('message');
    console.log('[DOM] Message element:', messageEl);

    const simKey = 'simulatedMonitor';
    let simulatedMonitor = null;
    const simRaw = localStorage.getItem(simKey);
    const jovenPerfilModal = document.getElementById('jovenPerfilModal');
    const jovenPerfilBody = document.getElementById('jovenPerfilBody');

    document.getElementById('closeJovenPerfilModal').onclick = () => {
      jovenPerfilModal.style.display = 'none';
    };

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    if (simRaw) {
      try {
        simulatedMonitor = JSON.parse(simRaw);
      } catch (e) {
        localStorage.removeItem(simKey);
      }
    }

    function updateSimulationBanner() {
      const banner = document.getElementById('simBanner');
      const nameEl = document.getElementById('simMonitorName');
      const exitBtn = document.getElementById('btnSalirSimulacionMonitor');

      if (simulatedMonitor && banner && nameEl && exitBtn) {
        nameEl.textContent = simulatedMonitor.nombre || simulatedMonitor.id;
        banner.style.display = 'block';
        exitBtn.onclick = () => {
          localStorage.removeItem(simKey);
          localStorage.removeItem('selectedEvento');
          window.location.reload();
        };
      } else if (banner) {
        banner.style.display = 'none';
      }
    }

    function getAuthHeaders(extra = {}) {
      const headers = { 'Authorization': 'Bearer ' + accessToken };
      if (simulatedMonitor && simulatedMonitor.id) {
        headers['X-Simulate-User'] = simulatedMonitor.id;
      }
      Object.assign(headers, extra);
      return headers;
    }

    if (!accessToken) {
      console.log('[AUTH] No hay token, redirigiendo a login');
      window.location.href = '/login';
    }

    updateSimulationBanner();

    function updateCurrentUserStorage(nextUserData) {
      const merged = Object.assign({}, currentUser || {}, nextUserData || {});
      localStorage.setItem('user', JSON.stringify(merged));
    }

    if (currentUser?.nombre_mostrado) {
      const profileNombre = document.getElementById('profile_nombre');
      if (profileNombre) profileNombre.value = currentUser.nombre_mostrado;
    }

    document.getElementById('monitorProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const nombre_mostrado = document.getElementById('profile_nombre').value.trim();
        const response = await fetch(`${API_URL}/api/auth/me/profile`, {
          method: 'PATCH',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ nombre_mostrado }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al actualizar perfil');

        updateCurrentUserStorage(data.user);
        messageEl.className = 'success';
        messageEl.textContent = 'Perfil actualizado correctamente';
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    });

    document.getElementById('monitorEmailForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const newEmail = document.getElementById('profile_email').value.trim();
        const password = document.getElementById('profile_email_password').value;

        const response = await fetch(`${API_URL}/api/auth/me/email`, {
          method: 'PATCH',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ newEmail, password }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al actualizar email');

        updateCurrentUserStorage({ email: newEmail });
        document.getElementById('profile_email').value = '';
        document.getElementById('profile_email_password').value = '';
        messageEl.className = 'success';
        messageEl.textContent = data.message || 'Correo actualizado correctamente';
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    });

    document.getElementById('monitorPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const currentPassword = document.getElementById('profile_current_password').value;
        const newPassword = document.getElementById('profile_new_password').value;

        const response = await fetch(`${API_URL}/api/auth/me/password`, {
          method: 'PATCH',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ currentPassword, newPassword }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al actualizar contraseña');

        document.getElementById('profile_current_password').value = '';
        document.getElementById('profile_new_password').value = '';
        messageEl.className = 'success';
        messageEl.textContent = data.message || 'Contraseña actualizada correctamente';
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    });

    // Variables globales para eventos
    let selectedEvento = null;
    let availableEventos = [];

    async function loadMonitorEventosFromLinks() {
      const response = await fetch(`${API_URL}/api/monitor/registration-link`, {
        headers: getAuthHeaders(),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error?.message || 'Error al cargar enlaces de monitor');
      }

      const eventosMap = new Map();
      if (data.data && data.data.length > 0) {
        data.data.forEach(link => {
          if (!eventosMap.has(link.evento_id)) {
            eventosMap.set(link.evento_id, {
              id: link.evento_id,
              nombre: link.evento_nombre,
              tipo: link.tipo || 'N/A',
            });
          }
        });
      }

      return Array.from(eventosMap.values());
    }

    // Función para cargar eventos del monitor
    async function loadMonitorEventos() {
      console.log('[EVENTOS] Cargando eventos del monitor...');
      try {
        const response = await fetch(`${API_URL}/api/monitor/eventos`, {
          headers: getAuthHeaders(),
        });

        if (response.ok) {
          const data = await response.json();
          availableEventos = (data.data || []).map(evento => ({
            id: evento.id,
            nombre: evento.nombre,
            tipo: evento.tipo || 'N/A',
          }));
        } else {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }

          availableEventos = await loadMonitorEventosFromLinks();
        }
        console.log('[EVENTOS] Eventos disponibles:', availableEventos.length);

        // Verificar si hay evento guardado en localStorage
        const saved = localStorage.getItem('selectedEvento');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            const exists = availableEventos.find(e => e.id === parsed.id);
            if (exists) {
              selectedEvento = exists;
              console.log('[EVENTOS] Evento restaurado desde localStorage:', selectedEvento.nombre);
            }
          } catch (e) {
            console.log('[EVENTOS] Error al parsear evento guardado');
          }
        }

        if (availableEventos.length === 0) {
          // Sin eventos asignados
          document.getElementById('eventSelectorContainer').innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No hay eventos asignados para este monitor.</p>';
          document.getElementById('eventSelectorContainer').style.display = 'block';
        } else if (availableEventos.length === 1) {
          // Solo un evento, seleccionar automáticamente
          selectedEvento = availableEventos[0];
          localStorage.setItem('selectedEvento', JSON.stringify(selectedEvento));
          console.log('[EVENTOS] Un solo evento, seleccionado automáticamente:', selectedEvento.nombre);
          showEventContent();
        } else if (selectedEvento) {
          // Múltiples eventos pero ya hay uno seleccionado
          showEventContent();
        } else {
          // Múltiples eventos, mostrar selector
          showEventSelector();
        }
      } catch (error) {
        console.error('[EVENTOS] Error:', error);
        try {
          availableEventos = await loadMonitorEventosFromLinks();
          if (availableEventos.length > 0) {
            showEventSelector();
            return;
          }
        } catch (_) {}

        document.getElementById('eventSelectorContainer').innerHTML = '<p style="color: red; text-align: center; padding: 2rem;">Error al cargar eventos</p>';
        document.getElementById('eventSelectorContainer').style.display = 'block';
      }
    }

    // Función para mostrar el selector de eventos
    function showEventSelector() {
      console.log('[EVENTOS] Mostrando selector...');
      document.getElementById('eventSelectorContainer').style.display = 'block';
      document.getElementById('eventContent').style.display = 'none';

      const container = document.getElementById('eventCards');
      container.innerHTML = '';

      availableEventos.forEach(evento => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 0.75rem;
          padding: 1.5rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          border: 2px solid transparent;
        `;
        
        card.onmouseover = () => {
          card.style.transform = 'translateY(-4px)';
          card.style.boxShadow = '0 8px 12px rgba(0,0,0,0.15)';
        };
        
        card.onmouseout = () => {
          card.style.transform = 'translateY(0)';
          card.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
        };

        card.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <h4 style="margin: 0; font-size: 1.25rem;">${evento.nombre}</h4>
          </div>
          <p style="color: #666; margin: 0;"><strong>Tipo:</strong> ${evento.tipo}</p>
          <button style="margin-top: 1rem; width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
            Seleccionar Evento
          </button>
        `;

        card.onclick = () => selectEvento(evento);
        container.appendChild(card);
      });
    }

    // Función para seleccionar un evento
    function selectEvento(evento) {
      console.log('[EVENTOS] Evento seleccionado:', evento.nombre);
      selectedEvento = evento;
      localStorage.setItem('selectedEvento', JSON.stringify(evento));
      showEventContent();
    }

    // Función para mostrar el contenido del evento seleccionado
    function showEventContent() {
      console.log('[EVENTOS] Mostrando contenido del evento:', selectedEvento.nombre);
      document.getElementById('eventSelectorContainer').style.display = 'none';
      document.getElementById('eventContent').style.display = 'block';

      // Actualizar header con info del evento
      document.getElementById('selectedEventName').textContent = selectedEvento.nombre;
      document.getElementById('selectedEventType').textContent = `Tipo: ${selectedEvento.tipo}`;

      // Ocultar botón de cambiar evento si solo hay uno
      if (availableEventos.length === 1) {
        document.getElementById('changeEventBtn').style.display = 'none';
      }

      // Cargar datos del evento seleccionado
      loadResumenEvento();
      loadRegistrationLinks();
      loadJovenes();
    }

    // Hacer función global para el botón
    window.showEventSelector = showEventSelector;

    async function loadRegistrationLinks() {
      console.log('[LINKS] Iniciando loadRegistrationLinks...');
      if (!selectedEvento) {
        console.log('[LINKS] No hay evento seleccionado');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/monitor/registration-link`, {
          headers: getAuthHeaders(),
        });

        const data = await response.json();

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.error?.message || 'Error al cargar enlaces');
        }

        const linksContainer = document.getElementById('registrationLinks');
        linksContainer.innerHTML = '';

        if (data.data && data.data.length > 0) {
          // Filtrar enlaces por evento seleccionado
          const filteredLinks = data.data.filter(link => link.evento_id === selectedEvento.id);
          
          if (filteredLinks.length > 0) {
            filteredLinks.forEach(link => {
              const div = document.createElement('div');
              div.style.cssText = 'background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #3b82f6;';
              div.innerHTML = `
                <p style="margin: 0 0 0.5rem 0;"><strong>${link.evento_nombre}</strong></p>
                <input type="text" value="${link.url}" readonly style="width: 100%; padding: 0.5rem; font-size: 0.9rem; margin-bottom: 0.5rem;" />
                <button onclick='window.copyToClipboard(${JSON.stringify(link.url)})' style="background-color: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">Copiar Enlace</button>
              `;
              linksContainer.appendChild(div);
            });
          } else {
            linksContainer.innerHTML = '<p style="color: #666;">No tienes enlaces de registro para este evento.</p>';
          }
        } else {
          linksContainer.innerHTML = '<p style="color: #666;">No tienes enlaces de registro asignados.</p>';
        }
      } catch (error) {
        console.error('Error loading registration links:', error);
        document.getElementById('registrationLinks').innerHTML = '<p style="color: red;">Error al cargar enlaces de registro</p>';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        messageEl.className = 'success';
        messageEl.textContent = 'OK: Enlace copiado al portapapeles';
        setTimeout(() => { messageEl.textContent = ''; }, 3000);
      }).catch(err => {
        messageEl.className = 'error';
        messageEl.textContent = 'Error al copiar: ' + err.message;
      });
    }

    // Hacer copyToClipboard global para que funcione desde HTML
    window.copyToClipboard = copyToClipboard;

    async function loadResumenEvento() {
      if (!selectedEvento) return;
      const container = document.getElementById('resumenEvento');
      container.innerHTML = '<div style="padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;">Cargando resumen...</div>';

      try {
        let response = await fetch(`${API_URL}/api/monitor/eventos/${selectedEvento.id}/recaudacion`, {
          headers: getAuthHeaders(),
        });

        let data = await response.json();

        let r = null;
        if (response.ok) {
          r = {
            total_pagado: Number(data.data?.recaudado || 0),
            total_presupuesto_esperado: Number(data.data?.esperado || 0),
            descuento_aplicado: 0,
            total_jovenes: Number(data.data?.total_jovenes || 0),
            max_jovenes: data.data?.max_jovenes,
          };
        } else {
          response = await fetch(`${API_URL}/api/monitor/resumen?evento_id=${selectedEvento.id}`, {
            headers: getAuthHeaders(),
          });
          data = await response.json();
          if (!response.ok) throw new Error(data.error?.message || 'Error al cargar resumen');
          r = data.data;
        }

        container.innerHTML = `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem;"><strong>Total pagado</strong><div style="font-size: 1.35rem; margin-top: 0.25rem;">€${Number(r.total_pagado || 0).toFixed(2)}</div></div>
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem;"><strong>Presupuesto esperado</strong><div style="font-size: 1.35rem; margin-top: 0.25rem;">€${Number(r.total_presupuesto_esperado || 0).toFixed(2)}</div></div>
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem;"><strong>Descuento aplicado</strong><div style="font-size: 1.35rem; margin-top: 0.25rem;">€${Number(r.descuento_aplicado || 0).toFixed(2)}</div></div>
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem;"><strong>Cupo jóvenes</strong><div style="font-size: 1.35rem; margin-top: 0.25rem;">${r.total_jovenes || 0}/${r.max_jovenes || 10}</div></div>
        `;
      } catch (error) {
        container.innerHTML = `<div style="padding: 1rem; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 0.5rem;">${error.message}</div>`;
      }
    }

    async function loadDocumentosJoven() {
      const jovenId = document.getElementById('joven_id').value;
      const container = document.getElementById('documentosJoven');
      if (!jovenId) {
        container.innerHTML = '<p style="color: #6b7280;">Selecciona un joven para revisar y validar documentos.</p>';
        return;
      }

      container.innerHTML = '<p style="color: #6b7280;">Cargando documentos...</p>';
      try {
        const response = await fetch(`${API_URL}/api/monitor/jovenes/${jovenId}/documentos`, {
          headers: getAuthHeaders(),
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al cargar documentos');

        if (!data.data || data.data.length === 0) {
          container.innerHTML = '<p style="color: #6b7280;">Este joven todavía no ha subido documentos.</p>';
          return;
        }

        container.innerHTML = data.data.map((doc) => `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <div>
              <div style="font-weight: 600;">${doc.nombre_original || doc.tipo}</div>
              <div style="font-size: 0.9rem; color: #6b7280;">Tipo: ${doc.tipo} · ${doc.validado ? 'Validado' : 'Pendiente'}</div>
            </div>
            ${doc.validado ? '<span style="color:#065f46; background:#d1fae5; border:1px solid #a7f3d0; padding:0.25rem 0.5rem; border-radius:0.5rem;">Validado</span>' : `<button onclick="window.validarDocumento('${doc.id}')" style="background:#10b981; color:white; border:none; border-radius:0.5rem; padding:0.5rem 0.75rem; cursor:pointer;">Validar</button>`}
          </div>
        `).join('');
      } catch (error) {
        container.innerHTML = `<p style="color: #991b1b;">${error.message}</p>`;
      }
    }

    window.validarDocumento = async function(docId) {
      try {
        const response = await fetch(`${API_URL}/api/monitor/documentos/${docId}/validar`, {
          method: 'PATCH',
          headers: getAuthHeaders(),
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al validar documento');

        messageEl.className = 'success';
        messageEl.textContent = data.mensaje || 'Documento validado';
        loadDocumentosJoven();
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    };

    async function loadJovenes() {
      console.log('[JOVENES] Iniciando loadJovenes...');
      console.log('[JOVENES] Evento seleccionado:', selectedEvento ? selectedEvento.nombre : 'NINGUNO');
      
      if (!selectedEvento) {
        console.log('[JOVENES] No hay evento seleccionado');
        return;
      }

      console.log('[JOVENES] API_URL:', API_URL);
      console.log('[JOVENES] accessToken:', accessToken ? 'existe' : 'NO EXISTE');
      
      try {
        console.log('[JOVENES] Haciendo fetch a:', `${API_URL}/api/monitor/jovenes`);
        
        const response = await fetch(`${API_URL}/api/monitor/jovenes`, {
          headers: getAuthHeaders(),
        });

        console.log('[JOVENES] Response recibida:', response.status, response.statusText);
        
        const data = await response.json();
        console.log('[JOVENES] Data parseada:', data);

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.error?.message || 'Error al cargar jóvenes');
        }

        const jovenesList = document.getElementById('jovenesList');
        const selectJoven = document.getElementById('joven_id');

        console.log('[DOM] Select element:', selectJoven);
        console.log('[DATA] Data received:', data);

        if (!selectJoven) {
          console.error('[ERROR] Select element #joven_id not found in DOM!');
          return;
        }

        // Limpiar contenido anterior
        jovenesList.innerHTML = '';
        selectJoven.innerHTML = '';
        
        // Agregar opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar Joven --';
        defaultOption.disabled = false;
        defaultOption.selected = true;
        selectJoven.appendChild(defaultOption);

        console.log('[SELECT] Default option added:', defaultOption);

        if (data.data && data.data.length > 0) {
          // Filtrar jóvenes por evento seleccionado
          const filteredJovenes = data.data.filter(joven => joven.evento_id === selectedEvento.id);
          
          console.log('[FILTER] Total jovenes:', data.data.length);
          console.log('[FILTER] Jovenes filtrados para evento', selectedEvento.id, ':', filteredJovenes.length);
          
          if (filteredJovenes.length > 0) {
            filteredJovenes.forEach((joven, index) => {
              console.log(`[JOVEN] Adding joven ${index + 1}:`, joven.nombre, joven.apellidos);
              
              // Agregar a la lista visual
              const div = document.createElement('div');
              div.style.cssText = 'background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #e5e7eb;';
              div.innerHTML = `
                <h4 style="margin: 0 0 0.5rem 0; color: #1f2937; cursor:pointer; text-decoration: underline;" onclick="window.verPerfilJoven('${joven.id}')">${escapeHtml(joven.nombre)} ${escapeHtml(joven.apellidos)}</h4>
                <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">
                  Documentos: ${joven.documentos_count || 0} | 
                  Pagos: ${joven.pagos_count || 0} | 
                  Total pagado: €${parseFloat(joven.total_pagado || 0).toFixed(2)}
                </p>
              `;
              jovenesList.appendChild(div);

              // Agregar al dropdown
              const option = document.createElement('option');
              option.value = joven.id;
              option.textContent = `${joven.nombre} ${joven.apellidos}`;
              selectJoven.appendChild(option);
              
              console.log(`[SUCCESS] Option ${index + 1} added:`, option.value, option.textContent);
            });

            console.log('[COMPLETE] Final select options count:', selectJoven.options.length);
            selectJoven.disabled = false;

            // Mensaje de éxito
            messageEl.className = 'success';
            messageEl.textContent = `OK: ${filteredJovenes.length} joven(es) cargado(s) para ${selectedEvento.nombre}`;
            setTimeout(() => { messageEl.textContent = ''; }, 3000);
          } else {
            console.log('[WARNING] No jovenes para este evento');
            jovenesList.innerHTML = '<p style="color: #666;">No hay jóvenes registrados en este evento. Comparte tu enlace de registro.</p>';
            selectJoven.innerHTML = '<option value="">-- No hay jóvenes disponibles --</option>';
            selectJoven.disabled = true;
          }
        } else {
          console.log('[WARNING] No jovenes data available');
          jovenesList.innerHTML = '<p style="color: #666;">No tienes jóvenes registrados. Comparte tu enlace de registro para que se inscriban.</p>';
          selectJoven.innerHTML = '<option value="">-- No hay jóvenes disponibles --</option>';
          selectJoven.disabled = true;
        }
      } catch (error) {
        console.error('[ERROR] ERROR en loadJovenes:', error);
        console.error('[ERROR] Error stack:', error.stack);
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
        document.getElementById('jovenesList').innerHTML = '<p style="color: red;">Error al cargar la lista de jóvenes</p>';
        document.getElementById('joven_id').innerHTML = '<option value="">-- Error al cargar --</option>';
        document.getElementById('joven_id').disabled = true;
      }
    }

    window.verPerfilJoven = async function(jovenId) {
      jovenPerfilBody.innerHTML = '<p style="color:#6b7280;">Cargando perfil...</p>';
      jovenPerfilModal.style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/api/monitor/jovenes/${jovenId}`, {
          headers: getAuthHeaders(),
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al cargar perfil');

        const joven = data.joven || {};
        const documentos = data.documentos || [];
        const pagos = data.pagos || [];

        jovenPerfilBody.innerHTML = `
          <div style="display:grid; gap:1rem;">
            <div style="background:#f8fafc; padding:1rem; border-radius:0.5rem; border:1px solid #e5e7eb;">
              <h4 style="margin:0 0 0.5rem 0;">${escapeHtml(joven.nombre)} ${escapeHtml(joven.apellidos)}</h4>
              <p style="margin:0; color:#374151;"><strong>ID:</strong> ${escapeHtml(joven.id)}</p>
              <div style="display:grid; gap:0.5rem; margin-top:0.75rem; grid-template-columns: 1fr 1fr auto; align-items:end;">
                <div>
                  <label style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.25rem;">Nombre</label>
                  <input id="editJovenNombre" value="${escapeHtml(joven.nombre || '')}" style="width:100%;" />
                </div>
                <div>
                  <label style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.25rem;">Apellidos</label>
                  <input id="editJovenApellidos" value="${escapeHtml(joven.apellidos || '')}" style="width:100%;" />
                </div>
                <button type="button" onclick="window.actualizarJovenDesdePerfil('${jovenId}')" style="height:38px; background:#2563eb; color:white; border:none; border-radius:0.35rem; padding:0 0.75rem;">Guardar</button>
              </div>
            </div>
            <div style="background:#fff; padding:1rem; border-radius:0.5rem; border:1px solid #e5e7eb;">
              <h4 style="margin:0 0 0.75rem 0;">Documentos</h4>
              ${documentos.length ? documentos.map((doc) => `<div style="padding:0.5rem 0; border-bottom:1px solid #f1f5f9;"><strong>${escapeHtml(doc.tipo)}</strong> · ${escapeHtml(doc.nombre_original || 'archivo')}</div>`).join('') : '<p style="margin:0; color:#6b7280;">Sin documentos</p>'}
            </div>
            <div style="background:#fff; padding:1rem; border-radius:0.5rem; border:1px solid #e5e7eb;">
              <h4 style="margin:0 0 0.75rem 0;">Pagos</h4>
              ${pagos.length ? pagos.map((p) => `<div style="padding:0.5rem 0; border-bottom:1px solid #f1f5f9;">Plazo ${p.plazo_numero} · €${Number(p.cantidad || 0).toFixed(2)} · ${p.pagado ? 'Pagado' : 'Pendiente'}</div>`).join('') : '<p style="margin:0; color:#6b7280;">Sin pagos</p>'}
            </div>
          </div>
        `;
      } catch (error) {
        jovenPerfilBody.innerHTML = `<p style="color:#b91c1c;">${escapeHtml(error.message)}</p>`;
      }
    };

    window.actualizarJovenDesdePerfil = async function(jovenId) {
      try {
        const nombre = document.getElementById('editJovenNombre')?.value?.trim();
        const apellidos = document.getElementById('editJovenApellidos')?.value?.trim();

        const response = await fetch(`${API_URL}/api/monitor/jovenes/${jovenId}`, {
          method: 'PATCH',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ nombre, apellidos }),
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Error al actualizar joven');

        messageEl.className = 'success';
        messageEl.textContent = data.mensaje || 'Joven actualizado';
        loadJovenes();
        window.verPerfilJoven(jovenId);
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    };

    document.getElementById('pagoForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const joven_id = document.getElementById('joven_id').value;
      const plazo_numero = parseInt(document.getElementById('plazo_numero').value);
      const cantidad = parseFloat(document.getElementById('cantidad').value);
      const descuento = parseFloat(document.getElementById('descuento').value || '0');
      const es_especial = document.getElementById('es_especial').checked;
      const nota_especial = document.getElementById('nota_especial').value.trim();

      try {
        messageEl.innerHTML = '';

        const response = await fetch(`${API_URL}/api/monitor/pagos`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ joven_id, plazo_numero, cantidad, descuento, es_especial, nota_especial }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error?.message || 'Error al registrar pago');
        }

        messageEl.className = 'success';
        messageEl.textContent = data.mensaje;
        document.getElementById('pagoForm').reset();
        document.getElementById('descuento').value = '0';

        // Recargar jóvenes
        setTimeout(() => {
          loadResumenEvento();
          loadJovenes();
          loadDocumentosJoven();
        }, 500);
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    });

    document.getElementById('joven_id').addEventListener('change', () => {
      loadDocumentosJoven();
    });

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/';
    }

    // Hacer logout global para que funcione desde HTML
    window.logout = logout;

    // Cargar datos iniciales
    console.log('[MAIN] Inicializando panel de monitor...');
    loadMonitorEventos();
    console.log('[MAIN] Carga de eventos iniciada');
  </script>
</Layout>
