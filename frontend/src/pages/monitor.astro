---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Panel de Monitor">
  <div style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0;">Panel de Monitor</h2>
      <button onclick="window.logout()" style="background-color: var(--color-danger); padding: 0.5rem 1rem;">Cerrar Sesión</button>
    </div>

    <div id="simBanner" style="display: none; background: #fff7ed; border: 1px solid #fed7aa; padding: 1rem 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
          <strong>Simulando monitor:</strong> <span id="simMonitorName">-</span>
        </div>
        <button id="btnSalirSimulacionMonitor" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Salir de simulacion</button>
      </div>
    </div>

    <!-- Selector de Eventos -->
    <div id="eventSelectorContainer" style="display: none;">
      <h3 style="margin-bottom: 1.5rem;">Selecciona un Evento</h3>
      <div id="eventCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
        <!-- Tarjetas de eventos se cargan aquí -->
      </div>
    </div>

    <!-- Contenido del evento seleccionado -->
    <div id="eventContent" style="display: none;">
      <div id="eventHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3 id="selectedEventName" style="margin: 0 0 0.5rem 0; font-size: 1.75rem;">-</h3>
            <p id="selectedEventType" style="margin: 0; opacity: 0.9;">-</p>
          </div>
          <button id="changeEventBtn" onclick="window.showEventSelector()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">
            Cambiar Evento
          </button>
        </div>
      </div>

      <h3 style="margin-top: 2rem;">Enlaces de Registro</h3>
      <div id="registrationLinks" style="margin: 1rem 0;"></div>

      <h3 style="margin-top: 2rem;">Jóvenes Registrados</h3>
      <div id="jovenesList" style="margin: 1rem 0;"></div>

      <h3 style="margin-top: 2rem;">Registrar Pago</h3>
      <form id="pagoForm" style="background: white; padding: 1.5rem; border-radius: 0.5rem; max-width: 500px;">
        <div style="margin-bottom: 1rem;">
          <label for="joven_id" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seleccionar Joven *</label>
          <select 
            id="joven_id" 
            name="joven_id" 
            required 
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; cursor: pointer;">
            <option value="">-- Cargando jóvenes... --</option>
          </select>
        </div>

        <div style="margin-bottom: 1rem;">
          <label for="plazo_numero" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Plazo # *</label>
          <input 
            type="number" 
            id="plazo_numero" 
            name="plazo_numero" 
            min="1" 
            required 
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />
        </div>

        <div style="margin-bottom: 1rem;">
          <label for="cantidad" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Cantidad (€) *</label>
          <input 
            type="number" 
            id="cantidad" 
            name="cantidad" 
            step="0.01" 
            min="0.01"
            required 
            style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" />
        </div>

        <button type="submit" style="width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600;">Registrar Pago</button>
      </form>

      <div id="message"></div>
    </div> <!-- Cierra eventContent -->
  </div> <!-- Cierra container principal -->

  <script>
    // @ts-nocheck
    // Capturar todos los errores
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('[ERROR GLOBAL]', msg);
      console.error('[URL]', url);
      console.error('[Line]', lineNo, 'Column:', columnNo);
      console.error('[Error object]', error);
      return false;
    };

    console.log('[INIT] Monitor script iniciado');
    
    // Obtener API_URL desde meta env o usar default
    const API_URL = 'http://localhost:3001';
    console.log('[CONFIG] API_URL:', API_URL);
    
    const accessToken = localStorage.getItem('accessToken');
    console.log('[AUTH] AccessToken existe:', !!accessToken);
    
    const messageEl = document.getElementById('message');
    console.log('[DOM] Message element:', messageEl);

    const simKey = 'simulatedMonitor';
    let simulatedMonitor = null;
    const simRaw = localStorage.getItem(simKey);
    if (simRaw) {
      try {
        simulatedMonitor = JSON.parse(simRaw);
      } catch (e) {
        localStorage.removeItem(simKey);
      }
    }

    function updateSimulationBanner() {
      const banner = document.getElementById('simBanner');
      const nameEl = document.getElementById('simMonitorName');
      const exitBtn = document.getElementById('btnSalirSimulacionMonitor');

      if (simulatedMonitor && banner && nameEl && exitBtn) {
        nameEl.textContent = simulatedMonitor.nombre || simulatedMonitor.id;
        banner.style.display = 'block';
        exitBtn.onclick = () => {
          localStorage.removeItem(simKey);
          localStorage.removeItem('selectedEvento');
          window.location.reload();
        };
      } else if (banner) {
        banner.style.display = 'none';
      }
    }

    function getAuthHeaders(extra = {}) {
      const headers = { 'Authorization': 'Bearer ' + accessToken };
      if (simulatedMonitor && simulatedMonitor.id) {
        headers['X-Simulate-User'] = simulatedMonitor.id;
      }
      Object.assign(headers, extra);
      return headers;
    }

    if (!accessToken) {
      console.log('[AUTH] No hay token, redirigiendo a login');
      window.location.href = '/login';
    }

    updateSimulationBanner();

    // Variables globales para eventos
    let selectedEvento = null;
    let availableEventos = [];

    // Función para cargar eventos del monitor
    async function loadMonitorEventos() {
      console.log('[EVENTOS] Cargando eventos del monitor...');
      try {
        const response = await fetch(`${API_URL}/api/monitor/registration-link`, {
          headers: getAuthHeaders(),
        });

        const data = await response.json();

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.error?.message || 'Error al cargar eventos');
        }

        // Extraer eventos únicos de los enlaces de registro
        const eventosMap = new Map();
        if (data.data && data.data.length > 0) {
          data.data.forEach(link => {
            if (!eventosMap.has(link.evento_id)) {
              eventosMap.set(link.evento_id, {
                id: link.evento_id,
                nombre: link.evento_nombre,
                tipo: link.tipo || 'N/A'
              });
            }
          });
        }

        availableEventos = Array.from(eventosMap.values());
        console.log('[EVENTOS] Eventos disponibles:', availableEventos.length);

        // Verificar si hay evento guardado en localStorage
        const saved = localStorage.getItem('selectedEvento');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            const exists = availableEventos.find(e => e.id === parsed.id);
            if (exists) {
              selectedEvento = exists;
              console.log('[EVENTOS] Evento restaurado desde localStorage:', selectedEvento.nombre);
            }
          } catch (e) {
            console.log('[EVENTOS] Error al parsear evento guardado');
          }
        }

        if (availableEventos.length === 0) {
          // Sin eventos asignados
          document.getElementById('eventSelectorContainer').innerHTML = '<p style="color: red; text-align: center; padding: 2rem;">No tienes eventos asignados. Contacta con el administrador.</p>';
          document.getElementById('eventSelectorContainer').style.display = 'block';
        } else if (availableEventos.length === 1) {
          // Solo un evento, seleccionar automáticamente
          selectedEvento = availableEventos[0];
          localStorage.setItem('selectedEvento', JSON.stringify(selectedEvento));
          console.log('[EVENTOS] Un solo evento, seleccionado automáticamente:', selectedEvento.nombre);
          showEventContent();
        } else if (selectedEvento) {
          // Múltiples eventos pero ya hay uno seleccionado
          showEventContent();
        } else {
          // Múltiples eventos, mostrar selector
          showEventSelector();
        }
      } catch (error) {
        console.error('[EVENTOS] Error:', error);
        document.getElementById('eventSelectorContainer').innerHTML = '<p style="color: red; text-align: center; padding: 2rem;">Error al cargar eventos</p>';
        document.getElementById('eventSelectorContainer').style.display = 'block';
      }
    }

    // Función para mostrar el selector de eventos
    function showEventSelector() {
      console.log('[EVENTOS] Mostrando selector...');
      document.getElementById('eventSelectorContainer').style.display = 'block';
      document.getElementById('eventContent').style.display = 'none';

      const container = document.getElementById('eventCards');
      container.innerHTML = '';

      availableEventos.forEach(evento => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 0.75rem;
          padding: 1.5rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          border: 2px solid transparent;
        `;
        
        card.onmouseover = () => {
          card.style.transform = 'translateY(-4px)';
          card.style.boxShadow = '0 8px 12px rgba(0,0,0,0.15)';
        };
        
        card.onmouseout = () => {
          card.style.transform = 'translateY(0)';
          card.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
        };

        card.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <h4 style="margin: 0; font-size: 1.25rem;">${evento.nombre}</h4>
          </div>
          <p style="color: #666; margin: 0;"><strong>Tipo:</strong> ${evento.tipo}</p>
          <button style="margin-top: 1rem; width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
            Seleccionar Evento
          </button>
        `;

        card.onclick = () => selectEvento(evento);
        container.appendChild(card);
      });
    }

    // Función para seleccionar un evento
    function selectEvento(evento) {
      console.log('[EVENTOS] Evento seleccionado:', evento.nombre);
      selectedEvento = evento;
      localStorage.setItem('selectedEvento', JSON.stringify(evento));
      showEventContent();
    }

    // Función para mostrar el contenido del evento seleccionado
    function showEventContent() {
      console.log('[EVENTOS] Mostrando contenido del evento:', selectedEvento.nombre);
      document.getElementById('eventSelectorContainer').style.display = 'none';
      document.getElementById('eventContent').style.display = 'block';

      // Actualizar header con info del evento
      document.getElementById('selectedEventName').textContent = selectedEvento.nombre;
      document.getElementById('selectedEventType').textContent = `Tipo: ${selectedEvento.tipo}`;

      // Ocultar botón de cambiar evento si solo hay uno
      if (availableEventos.length === 1) {
        document.getElementById('changeEventBtn').style.display = 'none';
      }

      // Cargar datos del evento seleccionado
      loadRegistrationLinks();
      loadJovenes();
    }

    // Hacer función global para el botón
    window.showEventSelector = showEventSelector;

    async function loadRegistrationLinks() {
      console.log('[LINKS] Iniciando loadRegistrationLinks...');
      if (!selectedEvento) {
        console.log('[LINKS] No hay evento seleccionado');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/monitor/registration-link`, {
          headers: getAuthHeaders(),
        });

        const data = await response.json();

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.error?.message || 'Error al cargar enlaces');
        }

        const linksContainer = document.getElementById('registrationLinks');
        linksContainer.innerHTML = '';

        if (data.data && data.data.length > 0) {
          // Filtrar enlaces por evento seleccionado
          const filteredLinks = data.data.filter(link => link.evento_id === selectedEvento.id);
          
          if (filteredLinks.length > 0) {
            filteredLinks.forEach(link => {
              const div = document.createElement('div');
              div.style.cssText = 'background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #3b82f6;';
              div.innerHTML = `
                <p style="margin: 0 0 0.5rem 0;"><strong>${link.evento_nombre}</strong></p>
                <input type="text" value="${link.url}" readonly style="width: 100%; padding: 0.5rem; font-size: 0.9rem; margin-bottom: 0.5rem;" />
                <button onclick="window.copyToClipboard('${link.url}')" style="background-color: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">Copiar Enlace</button>
              `;
              linksContainer.appendChild(div);
            });
          } else {
            linksContainer.innerHTML = '<p style="color: #666;">No tienes enlaces de registro para este evento.</p>';
          }
        } else {
          linksContainer.innerHTML = '<p style="color: #666;">No tienes enlaces de registro asignados.</p>';
        }
      } catch (error) {
        console.error('Error loading registration links:', error);
        document.getElementById('registrationLinks').innerHTML = '<p style="color: red;">Error al cargar enlaces de registro</p>';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        messageEl.className = 'success';
        messageEl.textContent = 'OK: Enlace copiado al portapapeles';
        setTimeout(() => { messageEl.textContent = ''; }, 3000);
      }).catch(err => {
        messageEl.className = 'error';
        messageEl.textContent = 'Error al copiar: ' + err.message;
      });
    }

    // Hacer copyToClipboard global para que funcione desde HTML
    window.copyToClipboard = copyToClipboard;

    async function loadJovenes() {
      console.log('[JOVENES] Iniciando loadJovenes...');
      console.log('[JOVENES] Evento seleccionado:', selectedEvento ? selectedEvento.nombre : 'NINGUNO');
      
      if (!selectedEvento) {
        console.log('[JOVENES] No hay evento seleccionado');
        return;
      }

      console.log('[JOVENES] API_URL:', API_URL);
      console.log('[JOVENES] accessToken:', accessToken ? 'existe' : 'NO EXISTE');
      
      try {
        console.log('[JOVENES] Haciendo fetch a:', `${API_URL}/api/monitor/jovenes`);
        
        const response = await fetch(`${API_URL}/api/monitor/jovenes`, {
          headers: getAuthHeaders(),
        });

        console.log('[JOVENES] Response recibida:', response.status, response.statusText);
        
        const data = await response.json();
        console.log('[JOVENES] Data parseada:', data);

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.error?.message || 'Error al cargar jóvenes');
        }

        const jovenesList = document.getElementById('jovenesList');
        const selectJoven = document.getElementById('joven_id');

        console.log('[DOM] Select element:', selectJoven);
        console.log('[DATA] Data received:', data);

        if (!selectJoven) {
          console.error('[ERROR] Select element #joven_id not found in DOM!');
          return;
        }

        // Limpiar contenido anterior
        jovenesList.innerHTML = '';
        selectJoven.innerHTML = '';
        
        // Agregar opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar Joven --';
        defaultOption.disabled = false;
        defaultOption.selected = true;
        selectJoven.appendChild(defaultOption);

        console.log('[SELECT] Default option added:', defaultOption);

        if (data.data && data.data.length > 0) {
          // Filtrar jóvenes por evento seleccionado
          const filteredJovenes = data.data.filter(joven => joven.evento_id === selectedEvento.id);
          
          console.log('[FILTER] Total jovenes:', data.data.length);
          console.log('[FILTER] Jovenes filtrados para evento', selectedEvento.id, ':', filteredJovenes.length);
          
          if (filteredJovenes.length > 0) {
            filteredJovenes.forEach((joven, index) => {
              console.log(`[JOVEN] Adding joven ${index + 1}:`, joven.nombre, joven.apellidos);
              
              // Agregar a la lista visual
              const div = document.createElement('div');
              div.style.cssText = 'background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #e5e7eb;';
              div.innerHTML = `
                <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">${joven.nombre} ${joven.apellidos}</h4>
                <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">
                  Documentos: ${joven.documentos_count || 0} | 
                  Pagos: ${joven.pagos_count || 0} | 
                  Total pagado: €${parseFloat(joven.total_pagado || 0).toFixed(2)}
                </p>
              `;
              jovenesList.appendChild(div);

              // Agregar al dropdown
              const option = document.createElement('option');
              option.value = joven.id;
              option.textContent = `${joven.nombre} ${joven.apellidos}`;
              selectJoven.appendChild(option);
              
              console.log(`[SUCCESS] Option ${index + 1} added:`, option.value, option.textContent);
            });

            console.log('[COMPLETE] Final select options count:', selectJoven.options.length);

            // Mensaje de éxito
            messageEl.className = 'success';
            messageEl.textContent = `OK: ${filteredJovenes.length} joven(es) cargado(s) para ${selectedEvento.nombre}`;
            setTimeout(() => { messageEl.textContent = ''; }, 3000);
          } else {
            console.log('[WARNING] No jovenes para este evento');
            jovenesList.innerHTML = '<p style="color: #666;">No hay jóvenes registrados en este evento. Comparte tu enlace de registro.</p>';
            selectJoven.innerHTML = '<option value="">-- No hay jóvenes disponibles --</option>';
            selectJoven.disabled = true;
          }
        } else {
          console.log('[WARNING] No jovenes data available');
          jovenesList.innerHTML = '<p style="color: #666;">No tienes jóvenes registrados. Comparte tu enlace de registro para que se inscriban.</p>';
          selectJoven.innerHTML = '<option value="">-- No hay jóvenes disponibles --</option>';
          selectJoven.disabled = true;
        }
      } catch (error) {
        console.error('[ERROR] ERROR en loadJovenes:', error);
        console.error('[ERROR] Error stack:', error.stack);
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
        document.getElementById('jovenesList').innerHTML = '<p style="color: red;">Error al cargar la lista de jóvenes</p>';
        document.getElementById('joven_id').innerHTML = '<option value="">-- Error al cargar --</option>';
        document.getElementById('joven_id').disabled = true;
      }
    }

    document.getElementById('pagoForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const joven_id = document.getElementById('joven_id').value;
      const plazo_numero = parseInt(document.getElementById('plazo_numero').value);
      const cantidad = parseFloat(document.getElementById('cantidad').value);

      try {
        messageEl.innerHTML = '';

        const response = await fetch(`${API_URL}/api/monitor/pagos`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ joven_id, plazo_numero, cantidad }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error?.message || 'Error al registrar pago');
        }

        messageEl.className = 'success';
        messageEl.textContent = data.mensaje;
        document.getElementById('pagoForm').reset();

        // Recargar jóvenes
        setTimeout(() => loadJovenes(), 1000);
      } catch (error) {
        messageEl.className = 'error';
        messageEl.textContent = 'Error: ' + error.message;
      }
    });

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/';
    }

    // Hacer logout global para que funcione desde HTML
    window.logout = logout;

    // Cargar datos iniciales
    console.log('[MAIN] Inicializando panel de monitor...');
    loadMonitorEventos();
    console.log('[MAIN] Carga de eventos iniciada');
  </script>
</Layout>
