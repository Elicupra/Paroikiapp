---
import Layout from "../layouts/Layout.astro";

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
---

<Layout title="Perfil de Monitor">
  <div style="max-width: 1280px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;">
      <h2 style="margin:0;">Perfil de Monitor</h2>
      <button onclick="window.logout()" style="background:#ef4444; color:white;">Cerrar Sesión</button>
    </div>

    <div id="message" style="display:none; margin-bottom:1rem; padding:0.85rem; border-radius:0.5rem;"></div>

    <div style="display:grid; grid-template-columns: 320px 1fr; gap:1rem; align-items:start;">
      <aside style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem; position:sticky; top:1rem;">
        <div id="currentProfileCard" style="margin-bottom:1rem;"></div>

        <div style="display:grid; gap:0.5rem; margin-bottom:1rem;">
          <button id="tabPerfil" style="text-align:left; background:#eef2ff; color:#1e3a8a; border:none;">Perfil</button>
          <button id="tabNotif" style="text-align:left; background:white; color:#374151; border:1px solid #d1d5db;">Notificaciones</button>
          <button id="tabDocs" style="text-align:left; background:white; color:#374151; border:1px solid #d1d5db;">Documentación</button>
        </div>

        <div id="adminMonitoresBox" style="display:none; margin-top:0.5rem;">
          <h4 style="margin:0 0 0.5rem 0;">Perfiles de monitores</h4>
          <label for="monitorSelect" style="display:block; margin-bottom:0.35rem; font-size:0.9rem; color:#6b7280;">Selecciona monitor</label>
          <select id="monitorSelect" style="width:100%;"></select>
        </div>
      </aside>

      <section>
        <div id="panelPerfil" style="display:block;"></div>
        <div id="panelNotif" style="display:none;"></div>
        <div id="panelDocs" style="display:none;"></div>
      </section>
    </div>
  </div>

  <script define:vars={{ API_URL }}>
    // @ts-nocheck
    const accessToken = localStorage.getItem('accessToken');
    const user = (() => {
      try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch (_) { return null; }
    })();

    if (!accessToken || !user) {
      window.location.href = '/login';
    }

    const isAdmin = user?.rol === 'administrador' || user?.rol === 'organizador';
    const isMonitor = user?.rol === 'monitor';

    if (!isAdmin && !isMonitor) {
      window.location.href = '/';
    }

    const state = {
      activeTab: 'perfil',
      monitorProfiles: [],
      selectedMonitorId: null,
      selectedMonitor: null,
      ownProfile: null,
      ownNotifications: null,
      ownFiles: [],
      adminFiles: [],
    };

    const messageEl = document.getElementById('message');
    const currentProfileCard = document.getElementById('currentProfileCard');
    const panelPerfil = document.getElementById('panelPerfil');
    const panelNotif = document.getElementById('panelNotif');
    const panelDocs = document.getElementById('panelDocs');
    const adminMonitoresBox = document.getElementById('adminMonitoresBox');
    const monitorSelect = document.getElementById('monitorSelect');

    function showMessage(text, type = 'error') {
      messageEl.style.display = 'block';
      messageEl.textContent = text;
      messageEl.style.background = type === 'success' ? '#d1fae5' : '#fee2e2';
      messageEl.style.color = type === 'success' ? '#065f46' : '#991b1b';
      setTimeout(() => { messageEl.style.display = 'none'; }, 4500);
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function fetchJson(url, options = {}, timeoutMs = 12000) {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal,
          headers: {
            Authorization: `Bearer ${accessToken}`,
            ...(options.headers || {}),
          },
        });

        const text = await response.text();
        let payload = null;
        try { payload = text ? JSON.parse(text) : null; } catch (_) { payload = null; }

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return null;
          }
          throw new Error(payload?.error?.message || `HTTP ${response.status}`);
        }

        return payload;
      } finally {
        clearTimeout(timeout);
      }
    }

    function setTab(tabName) {
      state.activeTab = tabName;
      const tabs = {
        perfil: document.getElementById('tabPerfil'),
        notif: document.getElementById('tabNotif'),
        docs: document.getElementById('tabDocs'),
      };

      Object.entries(tabs).forEach(([key, btn]) => {
        const active = key === tabName;
        btn.style.background = active ? '#eef2ff' : 'white';
        btn.style.color = active ? '#1e3a8a' : '#374151';
        btn.style.border = active ? 'none' : '1px solid #d1d5db';
      });

      panelPerfil.style.display = tabName === 'perfil' ? 'block' : 'none';
      panelNotif.style.display = tabName === 'notif' ? 'block' : 'none';
      panelDocs.style.display = tabName === 'docs' ? 'block' : 'none';
    }

    function renderCurrentProfileCard() {
      if (isAdmin && state.selectedMonitor) {
        currentProfileCard.innerHTML = `
          <div style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:0.6rem; padding:0.75rem;">
            <p style="margin:0; font-size:0.85rem; color:#6b7280;">Administrador conectado</p>
            <p style="margin:0.2rem 0 0.5rem 0; font-weight:600;">${escapeHtml(user.nombre_mostrado)} · ${escapeHtml(user.email)}</p>
            <p style="margin:0; font-size:0.85rem; color:#6b7280;">Gestionando monitor</p>
            <p style="margin:0.2rem 0 0 0; font-weight:600;">${escapeHtml(state.selectedMonitor.nombre_mostrado)}</p>
          </div>
        `;
        return;
      }

      const own = state.ownProfile || user;
      currentProfileCard.innerHTML = `
        <div style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:0.6rem; padding:0.75rem;">
          <p style="margin:0; font-size:0.85rem; color:#6b7280;">Perfil actual</p>
          <p style="margin:0.2rem 0 0 0; font-weight:600;">${escapeHtml(own.nombre_mostrado || user.nombre_mostrado)}</p>
          <p style="margin:0.2rem 0 0 0; color:#374151; font-size:0.9rem;">${escapeHtml(own.email || user.email)}</p>
        </div>
      `;
    }

    function renderPerfilPanel() {
      const profile = isAdmin ? state.selectedMonitor : state.ownProfile;
      if (!profile) {
        panelPerfil.innerHTML = '<p style="color:#6b7280;">Sin perfil seleccionado.</p>';
        return;
      }

      panelPerfil.innerHTML = `
        <div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem; margin-bottom:1rem;">
          <h3 style="margin:0 0 0.75rem 0;">Visión del perfil del monitor</h3>
          <form id="profileForm" style="display:grid; gap:0.85rem; max-width:700px;">
            <div>
              <label for="nombre_mostrado" style="display:block; margin-bottom:0.35rem; font-weight:600;">Nombre y apellidos</label>
              <input id="nombre_mostrado" value="${escapeHtml(profile.nombre_mostrado || '')}" style="width:100%;" required />
            </div>
            <div>
              <label for="email" style="display:block; margin-bottom:0.35rem; font-weight:600;">Correo electrónico</label>
              <input id="email" type="email" value="${escapeHtml(profile.email || '')}" style="width:100%;" required />
            </div>
            <div>
              <button type="submit">Guardar perfil</button>
            </div>
          </form>
        </div>

        ${isMonitor ? `
          <div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem;">
            <h3 style="margin:0 0 0.75rem 0;">Modificación de contraseña</h3>
            <form id="passwordForm" style="display:grid; gap:0.85rem; max-width:700px;">
              <div>
                <label for="currentPassword" style="display:block; margin-bottom:0.35rem; font-weight:600;">Contraseña actual</label>
                <input id="currentPassword" type="password" required style="width:100%;" />
              </div>
              <div>
                <label for="newPassword" style="display:block; margin-bottom:0.35rem; font-weight:600;">Nueva contraseña</label>
                <input id="newPassword" type="password" minlength="8" required style="width:100%;" />
              </div>
              <div>
                <button type="submit">Actualizar contraseña</button>
              </div>
            </form>
          </div>
        ` : ''}
      `;

      document.getElementById('profileForm')?.addEventListener('submit', saveProfile);
      document.getElementById('passwordForm')?.addEventListener('submit', updatePassword);
    }

    function renderNotificationsPanel() {
      const notif = isAdmin
        ? state.selectedMonitor
        : state.ownNotifications;

      if (!notif) {
        panelNotif.innerHTML = '<p style="color:#6b7280;">Sin información de notificaciones.</p>';
        return;
      }

      panelNotif.innerHTML = `
        <div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem;">
          <h3 style="margin:0 0 0.75rem 0;">Información de notificaciones</h3>
          <p style="margin:0 0 0.75rem 0; color:#6b7280;">Define dónde y cómo notificar: email y webhook.</p>
          <form id="notificationsForm" style="display:grid; gap:0.85rem; max-width:760px;">
            <div>
              <label for="notificacion_email" style="display:block; margin-bottom:0.35rem; font-weight:600;">Email de notificación</label>
              <input id="notificacion_email" type="email" value="${escapeHtml(notif.notificacion_email || notif.email || '')}" style="width:100%;" />
            </div>
            <div>
              <label for="notificacion_webhook" style="display:block; margin-bottom:0.35rem; font-weight:600;">Webhook de incidencias</label>
              <input id="notificacion_webhook" type="url" placeholder="https://..." value="${escapeHtml(notif.notificacion_webhook || '')}" style="width:100%;" />
            </div>
            <label style="display:flex; align-items:center; gap:0.5rem;">
              <input id="notificacion_email_habilitada" type="checkbox" ${notif.notificacion_email_habilitada ? 'checked' : ''} />
              <span>Activar notificación por email</span>
            </label>
            <div>
              <button type="submit">Guardar notificaciones</button>
            </div>
          </form>
        </div>
      `;

      document.getElementById('notificationsForm')?.addEventListener('submit', saveNotifications);
    }

    function renderDocsPanel() {
      if (isAdmin) {
        panelDocs.innerHTML = `
          <div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem;">
            <h3 style="margin:0 0 0.75rem 0;">Documentación del monitor</h3>
            ${state.adminFiles.length
              ? state.adminFiles.map((f) => `
                <div style="padding:0.65rem 0; border-bottom:1px solid #f3f4f6; display:flex; justify-content:space-between; gap:1rem; align-items:center; flex-wrap:wrap;">
                  <div>
                    <div style="font-weight:600;">${escapeHtml(f.nombre_original || 'archivo')}</div>
                    <div style="color:#6b7280; font-size:0.9rem;">${escapeHtml(f.mime_type || '-')} · ${new Date(f.subido_en).toLocaleString('es-ES')}</div>
                  </div>
                </div>
              `).join('')
              : '<p style="color:#6b7280; margin:0;">El monitor no tiene ficheros subidos.</p>'}
          </div>
        `;
        return;
      }

      panelDocs.innerHTML = `
        <div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem; margin-bottom:1rem;">
          <h3 style="margin:0 0 0.75rem 0;">Documentación (subida de ficheros)</h3>
          <form id="uploadForm" style="display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap;">
            <input id="docFile" type="file" required />
            <button type="submit">Subir fichero</button>
          </form>
        </div>

        <div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1rem;">
          ${state.ownFiles.length
            ? state.ownFiles.map((f) => `
              <div style="padding:0.65rem 0; border-bottom:1px solid #f3f4f6; display:flex; justify-content:space-between; gap:1rem; align-items:center; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:600;">${escapeHtml(f.nombre_original || 'archivo')}</div>
                  <div style="color:#6b7280; font-size:0.9rem;">${escapeHtml(f.mime_type || '-')} · ${new Date(f.subido_en).toLocaleString('es-ES')}</div>
                </div>
                <button class="btnDeleteFile" data-id="${f.id}" style="background:#ef4444;">Eliminar</button>
              </div>
            `).join('')
            : '<p style="color:#6b7280; margin:0;">No has subido documentación todavía.</p>'}
        </div>
      `;

      document.getElementById('uploadForm')?.addEventListener('submit', uploadOwnFile);
      panelDocs.querySelectorAll('.btnDeleteFile').forEach((btn) => {
        btn.addEventListener('click', async () => {
          await deleteOwnFile(btn.getAttribute('data-id'));
        });
      });
    }

    async function saveProfile(e) {
      e.preventDefault();
      const nombre_mostrado = document.getElementById('nombre_mostrado').value.trim();
      const email = document.getElementById('email').value.trim();

      try {
        if (isAdmin) {
          await fetchJson(`${API_URL}/api/admin/monitores/${state.selectedMonitorId}/perfil`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              nombre_mostrado,
              notificacion_email: state.selectedMonitor?.notificacion_email || email,
              notificacion_webhook: state.selectedMonitor?.notificacion_webhook || '',
              notificacion_email_habilitada: Boolean(state.selectedMonitor?.notificacion_email_habilitada),
            }),
          });
          showMessage('Perfil de monitor actualizado', 'success');
          await loadAdminProfiles();
        } else {
          await fetchJson(`${API_URL}/api/auth/me/profile`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre_mostrado }),
          });

          if (email !== (state.ownProfile?.email || user.email)) {
            const password = prompt('Introduce la contraseña actual para cambiar el email');
            if (password) {
              await fetchJson(`${API_URL}/api/auth/me/email`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newEmail: email, password }),
              });
            }
          }

          await loadOwnProfile();
          showMessage('Perfil actualizado', 'success');
        }
      } catch (error) {
        showMessage(`Error actualizando perfil: ${error.message}`);
      }
    }

    async function updatePassword(e) {
      e.preventDefault();
      try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;

        await fetchJson(`${API_URL}/api/auth/me/password`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword }),
        });

        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        showMessage('Contraseña actualizada', 'success');
      } catch (error) {
        showMessage(`Error actualizando contraseña: ${error.message}`);
      }
    }

    async function saveNotifications(e) {
      e.preventDefault();
      const notificacion_email = document.getElementById('notificacion_email').value.trim();
      const notificacion_webhook = document.getElementById('notificacion_webhook').value.trim();
      const notificacion_email_habilitada = document.getElementById('notificacion_email_habilitada').checked;

      try {
        if (isAdmin) {
          await fetchJson(`${API_URL}/api/admin/monitores/${state.selectedMonitorId}/perfil`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: state.selectedMonitor.email,
              nombre_mostrado: state.selectedMonitor.nombre_mostrado,
              notificacion_email,
              notificacion_webhook,
              notificacion_email_habilitada,
            }),
          });
          showMessage('Notificaciones del monitor actualizadas', 'success');
          await loadAdminProfiles();
        } else {
          await fetchJson(`${API_URL}/api/auth/me/notifications`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notificacion_email, notificacion_webhook, notificacion_email_habilitada }),
          });
          showMessage('Notificaciones actualizadas', 'success');
          await loadOwnNotifications();
        }
      } catch (error) {
        showMessage(`Error actualizando notificaciones: ${error.message}`);
      }
    }

    async function loadOwnProfile() {
      const payload = await fetchJson(`${API_URL}/api/auth/me/profile`);
      if (payload?.user) {
        state.ownProfile = payload.user;
      }
    }

    async function loadOwnNotifications() {
      const payload = await fetchJson(`${API_URL}/api/auth/me/notifications`);
      state.ownNotifications = payload?.data || null;
    }

    async function loadOwnFiles() {
      const payload = await fetchJson(`${API_URL}/api/monitor/ficheros`);
      state.ownFiles = Array.isArray(payload?.data) ? payload.data : [];
    }

    async function uploadOwnFile(e) {
      e.preventDefault();
      const fileInput = document.getElementById('docFile');
      const file = fileInput?.files?.[0];
      if (!file) return;

      try {
        const formData = new FormData();
        formData.append('archivo', file);

        const response = await fetch(`${API_URL}/api/monitor/ficheros`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${accessToken}` },
          body: formData,
        });

        const payload = await response.json();
        if (!response.ok) throw new Error(payload?.error?.message || `HTTP ${response.status}`);

        fileInput.value = '';
        showMessage('Fichero subido correctamente', 'success');
        await loadOwnFiles();
        renderDocsPanel();
      } catch (error) {
        showMessage(`Error subiendo fichero: ${error.message}`);
      }
    }

    async function deleteOwnFile(fileId) {
      if (!confirm('¿Eliminar este fichero?')) return;
      try {
        await fetchJson(`${API_URL}/api/monitor/ficheros/${fileId}`, { method: 'DELETE' });
        showMessage('Fichero eliminado', 'success');
        await loadOwnFiles();
        renderDocsPanel();
      } catch (error) {
        showMessage(`Error eliminando fichero: ${error.message}`);
      }
    }

    async function loadAdminProfiles() {
      const payload = await fetchJson(`${API_URL}/api/admin/monitores/perfiles`);
      state.monitorProfiles = Array.isArray(payload?.data) ? payload.data : [];

      monitorSelect.innerHTML = state.monitorProfiles.length
        ? state.monitorProfiles.map((p) => `<option value="${p.monitor_id}">${escapeHtml(p.nombre_mostrado)} · ${escapeHtml(p.email)}</option>`).join('')
        : '<option value="">Sin monitores</option>';

      if (!state.selectedMonitorId && state.monitorProfiles.length) {
        state.selectedMonitorId = state.monitorProfiles[0].monitor_id;
      }

      if (state.selectedMonitorId) {
        const selected = state.monitorProfiles.find((p) => String(p.monitor_id) === String(state.selectedMonitorId));
        state.selectedMonitor = selected || null;
      }

      if (state.selectedMonitorId) {
        await loadAdminMonitorFiles();
      }
    }

    async function loadAdminMonitorFiles() {
      if (!state.selectedMonitorId) {
        state.adminFiles = [];
        return;
      }
      const payload = await fetchJson(`${API_URL}/api/admin/monitores/${state.selectedMonitorId}/ficheros`);
      state.adminFiles = Array.isArray(payload?.data) ? payload.data : [];
    }

    function rerenderAll() {
      renderCurrentProfileCard();
      renderPerfilPanel();
      renderNotificationsPanel();
      renderDocsPanel();
    }

    async function initialize() {
      try {
        if (isAdmin) {
          adminMonitoresBox.style.display = 'block';
          state.ownProfile = { nombre_mostrado: user.nombre_mostrado, email: user.email };
          await loadAdminProfiles();

          monitorSelect.addEventListener('change', async () => {
            state.selectedMonitorId = monitorSelect.value;
            state.selectedMonitor = state.monitorProfiles.find((p) => String(p.monitor_id) === String(state.selectedMonitorId)) || null;
            await loadAdminMonitorFiles();
            rerenderAll();
          });
        } else {
          await loadOwnProfile();
          await loadOwnNotifications();
          await loadOwnFiles();
        }

        rerenderAll();
        setTab('perfil');
      } catch (error) {
        showMessage(`Error inicializando panel: ${error.message}`);
      }
    }

    document.getElementById('tabPerfil').addEventListener('click', () => setTab('perfil'));
    document.getElementById('tabNotif').addEventListener('click', () => setTab('notif'));
    document.getElementById('tabDocs').addEventListener('click', () => setTab('docs'));

    window.logout = function() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/';
    };

    initialize();
  </script>
</Layout>
