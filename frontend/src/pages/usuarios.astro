---
import Layout from '../layouts/Layout.astro';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
---

<Layout title="Usuarios (J贸venes)">
  <div style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
      <h2 style="margin: 0;">Usuarios 路 J贸venes</h2>
      <button id="btnToggleSearch" style="padding: 0.5rem 0.9rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background: white; cursor: pointer;"> Buscar</button>
    </div>

    <div id="scopeInfo" style="display:none; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af;"></div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
      <div>
        <label for="eventoFilter" style="display:block; margin-bottom:0.35rem; font-weight:600;">Evento</label>
        <select id="eventoFilter" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:0.5rem;"></select>
      </div>
      <div id="monitorFilterWrap" style="display:none;">
        <label for="monitorFilter" style="display:block; margin-bottom:0.35rem; font-weight:600;">Monitor</label>
        <select id="monitorFilter" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:0.5rem;"></select>
      </div>
      <div>
        <label for="fechaFilter" style="display:block; margin-bottom:0.35rem; font-weight:600;">Fecha de registro</label>
        <input id="fechaFilter" type="date" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:0.5rem;" />
      </div>
      <div style="display:flex; align-items:flex-end;">
        <button id="btnRefrescar" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:0.5rem; background:white; cursor:pointer;">Refrescar</button>
      </div>
    </div>

    <div id="searchBox" style="display:none; margin-bottom:1rem; background:white; border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.9rem;">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 0.75rem;">
        <div>
          <label for="nombreFilter" style="display:block; margin-bottom:0.35rem; font-weight:600;">Nombre</label>
          <input id="nombreFilter" type="text" placeholder="Filtrar por nombre" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:0.5rem;" />
        </div>
        <div>
          <label for="apellidosFilter" style="display:block; margin-bottom:0.35rem; font-weight:600;">Apellidos</label>
          <input id="apellidosFilter" type="text" placeholder="Filtrar por apellidos" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:0.5rem;" />
        </div>
      </div>
    </div>

    <div id="loading" style="text-align:center; padding:3rem; color:#6b7280;">Cargando j贸venes...</div>
    <div id="jovenesContainer" style="display:none;"></div>
    <div id="message" style="display:none; margin-top:1rem; padding:0.9rem; border-radius:0.5rem;"></div>
  </div>

  <script define:vars={{ API_URL }}>
    // @ts-nocheck
    const accessToken = localStorage.getItem('accessToken');
    const currentUser = JSON.parse(localStorage.getItem('user') || 'null');

    if (!accessToken || !currentUser) {
      window.location.href = '/login';
    }

    const role = currentUser?.rol;
    const isAdmin = role === 'administrador' || role === 'organizador';
    const isMonitor = role === 'monitor';

    if (!isAdmin && !isMonitor) {
      window.location.href = '/';
    }

    let jovenes = [];
    let eventosMap = new Map();

    const container = document.getElementById('jovenesContainer');
    const loading = document.getElementById('loading');
    const messageEl = document.getElementById('message');
    const scopeInfoEl = document.getElementById('scopeInfo');

    const escapeHtml = (value) => String(value ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    function showMessage(text, type) {
      messageEl.textContent = text;
      messageEl.style.display = 'block';
      messageEl.style.backgroundColor = type === 'success' ? '#d1fae5' : '#fee2e2';
      messageEl.style.color = type === 'success' ? '#065f46' : '#991b1b';
      setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
    }

    function toDay(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      return d.toISOString().slice(0, 10);
    }

    function getScopeInfo() {
      const params = new URLSearchParams(window.location.search);
      const scope = params.get('scope');
      if (scope === 'mine') {
        return isAdmin ? 'Mostrando vista filtrada por contexto de monitor.' : 'Mostrando tus j贸venes asignados.';
      }
      if (scope === 'all') {
        return isAdmin ? 'Mostrando todos los j贸venes registrados.' : 'Mostrando tus j贸venes asignados.';
      }
      return isAdmin ? 'Vista completa de j贸venes (admin).' : 'Vista de tus j贸venes asignados.';
    }

    async function loadEventos() {
      try {
        const endpoint = isAdmin ? '/api/admin/eventos?incluir_pasados=true' : '/api/monitor/eventos';
        const response = await fetch(`${API_URL}${endpoint}`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        const data = await response.json();
        if (!response.ok) return;
        const rows = Array.isArray(data.data) ? data.data : [];
        eventsFromRows(rows);
      } catch (_) {
      }
    }

    function eventsFromRows(rows) {
      eventosMap = new Map();
      for (const e of rows) {
        eventosMap.set(String(e.id), e.nombre || e.tipo || 'Evento');
      }
    }

    async function loadJovenes() {
      try {
        loading.style.display = 'block';
        container.style.display = 'none';

        const endpoint = isAdmin ? '/api/admin/jovenes' : '/api/monitor/jovenes';
        const response = await fetch(`${API_URL}${endpoint}`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        const data = await response.json();
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.error?.message || 'No se pudieron cargar los j贸venes');
        }

        jovenes = Array.isArray(data.data) ? data.data : [];
        fillFilters();
        renderJovenes();
      } catch (error) {
        showMessage(`Error al cargar j贸venes: ${error.message}`, 'error');
      } finally {
        loading.style.display = 'none';
      }
    }

    function fillFilters() {
      const eventoSel = document.getElementById('eventoFilter');
      const monitorSel = document.getElementById('monitorFilter');
      const monitorWrap = document.getElementById('monitorFilterWrap');

      const eventoOptions = ['<option value="todos">Todos los eventos</option>'];
      const monitorNames = new Map();

      for (const j of jovenes) {
        const eventoId = String(j.evento_id || '');
        const eventoNombre = j.evento_nombre || eventosMap.get(eventoId) || `Evento ${eventoId || '-'}`;
        if (eventoId && !eventoOptions.some((o) => o.includes(`value="${eventoId}"`))) {
          eventoOptions.push(`<option value="${eventoId}">${escapeHtml(eventoNombre)}</option>`);
        }

        if (isAdmin) {
          const monitorId = String(j.usuario_id || '');
          const monitorNombre = j.monitor_nombre || '-';
          if (monitorId) monitorNames.set(monitorId, monitorNombre);
        }
      }

      eventoSel.innerHTML = eventoOptions.join('');

      if (isAdmin) {
        monitorWrap.style.display = 'block';
        const monitorOptions = ['<option value="todos">Todos los monitores</option>'];
        for (const [id, name] of monitorNames.entries()) {
          monitorOptions.push(`<option value="${id}">${escapeHtml(name)}</option>`);
        }
        monitorSel.innerHTML = monitorOptions.join('');
      } else {
        monitorWrap.style.display = 'none';
      }
    }

    function renderJovenes() {
      const eventoFilter = document.getElementById('eventoFilter').value;
      const monitorFilter = isAdmin ? document.getElementById('monitorFilter').value : 'todos';
      const fechaFilter = document.getElementById('fechaFilter').value;
      const nombreFilter = document.getElementById('nombreFilter').value.trim().toLowerCase();
      const apellidosFilter = document.getElementById('apellidosFilter').value.trim().toLowerCase();

      const filtered = jovenes.filter((j) => {
        if (eventoFilter !== 'todos' && String(j.evento_id || '') !== eventoFilter) return false;
        if (monitorFilter !== 'todos' && String(j.usuario_id || '') !== monitorFilter) return false;
        if (fechaFilter && toDay(j.creado_en) !== fechaFilter) return false;
        if (nombreFilter && !String(j.nombre || '').toLowerCase().includes(nombreFilter)) return false;
        if (apellidosFilter && !String(j.apellidos || '').toLowerCase().includes(apellidosFilter)) return false;
        return true;
      });

      container.style.display = 'block';

      if (!filtered.length) {
        container.innerHTML = '<p style="text-align:center; padding:2rem; color:#6b7280;">No hay j贸venes con los filtros actuales.</p>';
        return;
      }

      container.innerHTML = `
        <div style="overflow:auto; background:white; border:1px solid #e5e7eb; border-radius:0.75rem;">
          <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
              <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                <th style="padding:0.75rem; text-align:left;">Nombre</th>
                <th style="padding:0.75rem; text-align:left;">Apellidos</th>
                <th style="padding:0.75rem; text-align:left;">Evento</th>
                <th style="padding:0.75rem; text-align:left;">Monitor</th>
                <th style="padding:0.75rem; text-align:left;">Documentos</th>
                <th style="padding:0.75rem; text-align:left;">Pagos</th>
                <th style="padding:0.75rem; text-align:left;">Registro</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map((j) => {
                const eventoNombre = j.evento_nombre || eventosMap.get(String(j.evento_id || '')) || '-';
                const monitorNombre = isAdmin ? (j.monitor_nombre || '-') : (currentUser?.nombre_mostrado || 'Mi monitor');
                return `
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:0.75rem;">${escapeHtml(j.nombre)}</td>
                    <td style="padding:0.75rem;">${escapeHtml(j.apellidos)}</td>
                    <td style="padding:0.75rem;">${escapeHtml(eventoNombre)}</td>
                    <td style="padding:0.75rem;">${escapeHtml(monitorNombre)}</td>
                    <td style="padding:0.75rem;">${Number(j.documentos_count || 0)}</td>
                    <td style="padding:0.75rem;">${Number(j.pagos_count || 0)}</td>
                    <td style="padding:0.75rem;">${toDay(j.creado_en) || '-'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    document.getElementById('btnToggleSearch').addEventListener('click', () => {
      const searchBox = document.getElementById('searchBox');
      searchBox.style.display = searchBox.style.display === 'none' ? 'block' : 'none';
    });

    ['eventoFilter', 'monitorFilter', 'fechaFilter', 'nombreFilter', 'apellidosFilter'].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', renderJovenes);
      if (el && el.tagName === 'SELECT') el.addEventListener('change', renderJovenes);
    });

    document.getElementById('btnRefrescar').addEventListener('click', loadJovenes);

    scopeInfoEl.textContent = getScopeInfo();
    scopeInfoEl.style.display = 'block';

    loadEventos().then(loadJovenes);
  </script>
</Layout>
